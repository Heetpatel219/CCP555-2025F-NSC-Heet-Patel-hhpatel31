# .github/workflows/ci-assignment3.yml
# Continuous Integration (CI) Workflow for Assignment 3

name: Assignment 3 CI

on:
  pull_request:
    branches:
      - main
    paths:
      - 'assignment 3/**'
  push:
    branches:
      - main
    paths:
      - 'assignment 3/**'

jobs:
  # Job 1: Dockerfile Lint (Hadolint) - warnings only
  dockerfile-lint:
    name: Assignment 3 - Dockerfile Lint
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "assignment 3/Dockerfile"
          failure-threshold: error
          ignore: DL3018,DL3008,SC2086

  # Job 2: ESLint - warnings only
  lint:
    name: Assignment 3 - ESLint
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: "assignment 3/package-lock.json"
      - run: npm ci
        working-directory: "assignment 3"
      - run: npm run lint || echo "ESLint found issues (non-blocking)"
        working-directory: "assignment 3"

  # Job 3: Unit Tests - warnings only
  unit-tests:
    name: Assignment 3 - Unit Tests
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: "assignment 3/package-lock.json"
      - run: npm ci
        working-directory: "assignment 3"
      - run: npm test || echo "Some tests failed (non-blocking)"
        working-directory: "assignment 3"

  # Job 4: Build Docker Image - REQUIRED
  docker-build:
    name: Assignment 3 - Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: "assignment 3"
          file: "assignment 3/Dockerfile"
          push: false
          tags: fragments:test

  # Job 5: Push to Docker Hub (optional)
  docker-hub:
    name: Assignment 3 - Push to Docker Hub
    needs: [docker-build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: "assignment 3"
          file: "assignment 3/Dockerfile"
          push: ${{ secrets.DOCKERHUB_USERNAME != '' }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/fragments:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/fragments:${{ github.sha }}
        continue-on-error: true
